services:
  # ==================== PostgreSQL Shards ====================
  postgres-0:
    image: postgres:15-alpine
    container_name: postgres-0
    environment:
      POSTGRES_PASSWORD: SecurePass123!
      POSTGRES_USER: sharding_user
      POSTGRES_DB: sharding_db
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5433:5432"
    volumes:
      - data0:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - app-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U sharding_user -d sharding_db" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s
    restart: unless-stopped

  postgres-1:
    image: postgres:15-alpine
    container_name: postgres-1
    environment:
      POSTGRES_PASSWORD: SecurePass123!
      POSTGRES_USER: sharding_user
      POSTGRES_DB: sharding_db
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5434:5432"
    volumes:
      - data1:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - app-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U sharding_user -d sharding_db" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s
    restart: unless-stopped

  # ==================== ShardingSphere Proxy ====================
  shardingsphere-proxy:
    image: apache/shardingsphere-proxy:5.4.1
    container_name: shardingsphere-proxy
    depends_on:
      postgres-0:
        condition: service_healthy
      postgres-1:
        condition: service_healthy
    ports:
      - "3307:3307"
    volumes:
      - ./shardingsphere/config-sharding.yaml:/opt/shardingsphere-proxy/conf/config-sharding.yaml:ro
      - ./shardingsphere/server.yaml:/opt/shardingsphere-proxy/conf/server.yaml:ro
    networks:
      - app-network
    healthcheck:
      test: [ "CMD", "sh", "-c", "echo > /dev/tcp/localhost/3307" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    restart: unless-stopped

  # ==================== Transaction Service ====================
  #  transaction-service-api:
  #    build:
  #      context: .
  #      dockerfile: Dockerfile
  #    container_name: transaction-service
  #    ports:
  #      - "8091:8091"
  #    environment:
  #      SPRING_PROFILES_ACTIVE: docker
  #      SPRING_DATASOURCE_URL: jdbc:postgresql://shardingsphere-proxy:3307/sharding_db
  #      SPRING_DATASOURCE_USERNAME: sharding_user
  #      SPRING_DATASOURCE_PASSWORD: SecurePass123!
  #      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: "20"
  #      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: "5"
  #      SPRING_JPA_HIBERNATE_DDL_AUTO: none
  #      INDIVIDUALS_API_URL: http://individuals-service:8081/api/v1
  #      INDIVIDUALS_API_CONNECT_TIMEOUT: "5000"
  #      INDIVIDUALS_API_READ_TIMEOUT: "10000"
  #      KAFKA_BOOTSTRAP_SERVERS: kafka1:9092,kafka2:9092,kafka3:9092
  #      MANAGEMENT_METRICS_EXPORT_PROMETHEUS_ENABLED: "true"
  #      ENV: docker
  #      OTLP_EXPORTER_ENDPOINT: http://alloy:4318
  #    depends_on:
  #      shardingsphere-proxy:
  #        condition: service_healthy
  #      kafka1:
  #        condition: service_healthy
  #      kafka2:
  #        condition: service_healthy
  #      kafka3:
  #        condition: service_healthy
  #    networks:
  #      - app-network
  #    healthcheck:
  #      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8091/api/actuator/health"]
  #      interval: 10s
  #      timeout: 5s
  #      retries: 5
  #      start_period: 60s
  #     restart: unless-stopped

  # ==================== Zookeeper ====================
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
      ZOOKEEPER_INIT_LIMIT: 5
      ZOOKEEPER_SYNC_LIMIT: 2
    networks:
      - app-network
    healthcheck:
      test: [ "CMD-SHELL", "echo ruok | nc -w 5 localhost 2181 | grep imok || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ==================== Kafka Broker (Single Node) ====================
  kafka1:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka1
    hostname: kafka1
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,PLAINTEXT_INTERNAL://0.0.0.0:29092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://host.docker.internal:9092,PLAINTEXT_INTERNAL://kafka1:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_INTERNAL:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT_INTERNAL
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_DEFAULT_REPLICATION_FACTOR: 1
      KAFKA_MIN_INSYNC_REPLICAS: 1
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_LOG_RETENTION_HOURS: 168
      KAFKA_LOG_DIRS: /var/lib/kafka/data
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
    volumes:
      - kafka_data:/var/lib/kafka/data
    depends_on:
      zookeeper:
        condition: service_started
    networks:
      - app-network
    healthcheck:
      test: [ "CMD-SHELL", "kafka-broker-api-versions --bootstrap-server localhost:9092 || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # ==================== Kafka Exporter ====================
  kafka-exporter:
    image: danielqsj/kafka-exporter
    container_name: kafka-exporter
    command:
      - "--kafka.server=kafka1:29092"
      - "--log.level=info"
      - "--topic.filter=.*"
      - "--group.filter=.*"
    ports:
      - "9308:9308"
    depends_on:
      kafka1:
        condition: service_healthy
    networks:
      - app-network
    healthcheck:
      test: [ "CMD-SHELL", "wget --spider -q http://localhost:9308/metrics || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ==================== Schema Registry ====================
  schema-registry:
    image: confluentinc/cp-schema-registry:7.5.0
    container_name: schema-registry
    ports:
      - "8081:8081"
    environment:
      SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS: kafka1:29092
      SCHEMA_REGISTRY_HOST_NAME: schema-registry
      SCHEMA_REGISTRY_LISTENERS: http://0.0.0.0:8081
      SCHEMA_REGISTRY_KAFKASTORE_TOPIC: _schemas
      SCHEMA_REGISTRY_KAFKASTORE_TOPIC_REPLICATION_FACTOR: 1
      SCHEMA_REGISTRY_AVRO_COMPATIBILITY_LEVEL: backward
      SCHEMA_REGISTRY_KAFKASTORE_SECURITY_PROTOCOL: PLAINTEXT
    volumes:
      - schema_registry_data:/etc/schema-registry
    depends_on:
      kafka1:
        condition: service_healthy
    networks:
      - app-network
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:8081/subjects || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped


  # ==================== Prometheus ====================
  prometheus:
    image: prom/prometheus
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/prometheus/alert.rules.yml:/etc/prometheus/alert.rules.yml:ro
      - prometheus_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.console.libraries=/usr/share/prometheus/console_libraries"
      - "--web.console.templates=/usr/share/prometheus/consoles"
      - "--web.enable-lifecycle"
      - "--storage.tsdb.retention.time=15d"
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ==================== Grafana ====================
  grafana:
    image: grafana/grafana-oss:10.3.3
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_SERVER_ROOT_URL: http://localhost:3000
      GF_AUTH_ANONYMOUS_ENABLED: "false"
    volumes:
      - grafana-storage:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
    depends_on:
      prometheus:
        condition: service_healthy
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
#
#  # ==================== Tempo (Distributed Tracing) ====================
#  tempo:
#    image: grafana/tempo:2.4.1
#    container_name: tempo
#    command: ["-config.file=/etc/tempo/tempo.yaml"]
#    volumes:
#      - ./monitoring/tempo/tempo.yaml:/etc/tempo/tempo.yaml:ro
#      - tempo_data:/var/tempo
#    ports:
#      - "3200:3200"
#      - "4317:4317"
#      - "4318:4318"
#    networks:
#      - app-network
#    restart: unless-stopped
#
#  # ==================== Loki (Logs) ====================
#  loki:
#    image: grafana/loki:2.9.2
#    container_name: loki
#    ports:
#      - "3100:3100"
#    command: -config.file=/etc/loki/loki-config.yaml
#    volumes:
#      - ./monitoring/loki/loki-config.yaml:/etc/loki/loki-config.yaml:ro
#      - loki_chunks:/tmp/loki/chunks
#      - loki_index:/tmp/loki/index
#      - loki_rules:/tmp/loki/rules
#    networks:
#      - app-network
#    restart: unless-stopped
#
#  # ==================== Alloy (Telemetry Collector) ====================
#  alloy:
#    image: grafana/alloy:v1.3.0
#    container_name: alloy
#    user: root
#    ports:
#      - "9080:9080"
#      - "12345:12345"
#    volumes:
#      - ./monitoring/alloy/config.alloy:/etc/alloy/config.alloy:ro
#      - alloy_data:/var/lib/alloy/data
#      - /var/run/docker.sock:/var/run/docker.sock:ro
#    networks:
#      - app-network
#    command:
#      - run
#      - --server.http.listen-addr=0.0.0.0:9080
#      - --server.http.ui-path-prefix=/
#      - --storage.path=/var/lib/alloy/data
#      - /etc/alloy/config.alloy
#    depends_on:
#      loki:
#        condition: service_started
#      tempo:
#        condition: service_started
#      prometheus:
#        condition: service_healthy
#    restart: unless-stopped

networks:
  app-network:
    driver: bridge

volumes:
  data0:
  data1:
  kafka_data:
  schema_registry_data:
  prometheus_data:
  grafana-storage:
  loki_chunks:
  loki_index:
  loki_rules:
  tempo_data:
  alloy_data: